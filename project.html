<!-- 
Francys Scott and Susie Carovillano
November 2014
CS 307
project.html

Update the description below

Creates a room with a a ball, umbrella, table with lathed legs, teapot, and a window
with the sounds and view of a rainy day. (Note: Textures make take a little 
while to properly load and render.)

Manipulate the sceneParams to change the scene's details.
Details available to change:
	room's size;
	wall, ceiling, and floor textures;
	window's width and frame color;
	ball's color, radius, shininess, and specular light interactions;
	table's height, width, color, texture, and shininess;
	umbrella canopy's color, size, texture, shininess, and specular light interactions;
	umbrella handle's color;
	teapot's size, shininess, and ambient, diffuse, and specular light interactions;
	ambient light's color;
	and directional light's color.
	
 -->

<html>
  <head>
    <title>CS307 Final</title>
    <style>      
      canvas {
          display: block;
          margin: 10px auto;
          width: 800px;
          height: 500px;
      }
    </style>
    <script src="http://cs.wellesley.edu/~cs307/threejs/libs/three.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/libs/OrbitControls.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/libs/tw.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/libs/dat.gui.min.js"></script>
    <!-- Personal scripts with our helper methods for various objects. -->
    <script src="createBall.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/fscottRoom.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/fscottTable.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/scarovilUmbrella.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/fscott_scarovilWindow.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/scarovil_fscottTeapot.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/sbailinPenguinFIXED.js"></script>
    <script src="http://cs.wellesley.edu/~cs307/threejs/contrib/createRocket.js"></script>
    <script src="scarovilShinyBall.js"></script>
    <script src="Chandelier.js"></script>
	<script src="block.js"></script>
    <script src="fscott_scarovilSlide.js"></script>
    <script src="shelf.js"></script>

  </head>
  <body>

  <script id="prog">

  //global variables for animation
  var scene = new THREE.Scene(); 
  var renderer = new THREE.WebGLRenderer();
  var marble;
  var marbleCam; 
  
  TW.mainInit(renderer,scene);

  TW.makeColor = function(r,g,b) {
    // Input values are in 0-1; return value is a 24-bit number
    // to determine the hex code, just do val.toString(16).
    // You might have to add a leading zero.
    function unsignedByte(p) {
        if( 0 <= p && p <= 1 ) {
            return Math.round(p*255);
        }
        throw "primary not in [0,1]";
    }

    var intValue = 256*256*unsignedByte(r) + 256*unsignedByte(g) + unsignedByte(b);
    var hexString = intValue.toString(16);
    console.log("r: "+r+" g: "+g+" b: "+b+" hexString: 0x"+hexString+" int: "+intValue);
    return intValue;
  };

  var sceneParams = { roomH : 200,
					wallTexture: "../images/beige_wallpaper.jpg",
					ceilingTexture: "../images/wood-pattern.jpg",
					floorTexture: "../images/wood-pattern.jpg",
					//window
					windowWidth: 150,
					windowframeColor: 0x5E2612,
					windowVideo: "../videos/Gentlerain.ogv",
					//ball
					ballColor: 0xBB33FF,
					ballRad: 6,
                    ballSpecular: 0x444444,
                    ballShininess: 20,
                    //table
                    tableHeight: 50,
                    tableWidth: 90,
                    tableColor: 0x835930,
                    tableTexture: '../images/dark-wood.jpg',
                    tableShininess: 10,
                    //umbrella
                    umbrellaColor: 0x524CFD,
                    umbrellaSpecular: 0x444444,
                    umbrellaShininess: 5,
                    umbrellaSize: 25,
                    umbrellaTexture: '../images/stripes.jpg',
                    handleColor: 0x663300,
                    //block
                    blockColor: 0xFFFFFF,
                    blockSpecular: 0x333333,
                    blockShininess: 1,
                    blockSize: 10,
                    blockTexture: '../images/ivory-wood.jpg',
                    //teapot
                    teapotAmbient: TW.makeColor(0.135, 0.2225, 0.1575), //values are for jade
                    teapotDiffuse: TW.makeColor(0.54, 0.89, 0.63), //from OpenGL/VRML Materials
                    teapotSpecular: TW.makeColor(0.316228, 0.316228, 0.316228),
                    teapotShininess: 128 * 0.1,
                    teapotSize: 5,
                    //small slide
                    slideHeight: 30,
                    slideLength: 40,
                    slideWidth: 5,
                    slideColor: 0xFFAA00,
                    slideShininess: 10,
                    slideLip: true,
                    //ramp
                    rampHeight: 50,
                    rampLength: 80,
                    rampWidth: 20,
                    rampColor: 0xFF8844,
                    rampShininess: 20,
                    rampLip: false,
                    //bowling ball
                    marbleRadius: 12,
    				marbleColor: 0x524CFD,
    				marbleSpecular: 0x444444,
                    marbleShininess: 20,
    				marbleVelocityX: 0.8,
    				marbleVelocityZ: 0.4,
    				marbleInitialX: 0,
    				marbleInitialY: 50,
    				marbleInitialZ: -140,
    				marbleAngularVelocity: TW.degrees2radians(3),
    				marbleInitialAngle: -Math.PI/4,
    				//shelves
    				shelfColor: 0xDDDDDD,
    				shelfSpecular: 0x333333,
    				shelfShininess: 3,
    				shelfHeight: 12,
    				shelfWidth: 30,
    				shelfLength: 100,
    				shelfTexture: '../images/dark-wood.jpg',
    				// toy rocket
    				toyRocketBodyColor:  0x0088FF,
    				toyRocketNoseColor:  0xFF4444,
    				toyRocketFinColor:  0xFF00FF,
    				toyRocketThrusterColor:  0xFF8800,
    				toyRocketCabinColor:  0x0000FF,
                    //lights
                    ambLightColor: 0x6F6F6F,
                    dirLightColor: 0xAAAAAA,
                    //animation
       				deltaT: 0.5,        // time between steps, in arbitrary time units
                    lastElement : null
                  };

  var animationState = {
        marbleAngle: sceneParams.marbleInitialAngle,
        marbleX: sceneParams.marbleInitialX,
        marbleY: sceneParams.marbleInitialY,
        marbleZ: sceneParams.marbleInitialZ,
        time: 0,
        lastParam: null
    };

  function drawScene() {

    // Create and place the room in which the objects appear
    var w2 = sceneParams.roomH / 2;		// one-half the room length
	var room = createRoom(sceneParams.roomH, 
							sceneParams.wallTexture, 
							sceneParams.ceilingTexture, 
							sceneParams.floorTexture);
	room.name="room";
	room.position.set(0, w2, 0);  // Increase y so that the origin is at the right spot
	scene.add(room);
	
	// Create and place table
	var table = createTexturedTable(sceneParams.tableHeight, // for woodgrain table
							sceneParams.tableWidth, 
							sceneParams.tableTexture, 
							sceneParams.tableShininess);
	table.name = "table";
	table.position.set(-30,sceneParams.tableHeight, -90);  // Put in back of room
	table.rotation.y = Math.PI * 0.5; //rotate 90 degrees
	scene.add(table);
	
	// Create and place ball in room
	var ball = createBall(sceneParams.ballRad, 
							sceneParams.ballColor, 
							sceneParams.ballShininess);
    ball.name = "ball";         // give it a name, so we can remove it next time.
	// Put ball in front left corner of room    
    ball.position.set(-130, 0, 70);
    scene.add(ball);
    
    //Create and place Umbrella in room
    var umbrella = createUmbrella(sceneParams.umbrellaColor, 
							sceneParams.umbrellaSpecular, 
							sceneParams.umbrellaShininess,
							sceneParams.umbrellaSize, 
							sceneParams.umbrellaTexture,
							sceneParams.handleColor);
	umbrella.name = "umbrella";
	umbrella.position.set(-100, 26, 90);  // Place in room on floor in front left corner
	umbrella.rotateX(Math.PI/2);		// rotate top of umbrella so two spokes rest on floor
	umbrella.rotateY(-Math.PI/3.67);	// rotate umbrella so spokes and cane rest on floor
	umbrella.rotateZ(-Math.PI/8);
	scene.add(umbrella);
	
	//Create and place shelves
	var shelf1 = createShelf(sceneParams.shelfWidth, sceneParams.shelfHeight, sceneParams.shelfLength,
							sceneParams.shelfTexture, sceneParams.shelfColor, sceneParams.shelfSpecular,
							sceneParams.shelfShininess);
	shelf1.position.set(150, 140, -100);
	scene.add(shelf1);
	
	var shelf2 = shelf1.clone();
	shelf2.rotateY(Math.PI/2);
	shelf2.position.set(100, 100, -150);
	scene.add(shelf2);
	
	//Create and place teapot
	var teapot = createTeapot(sceneParams.teapotDiffuse, sceneParams.teapotAmbient, 
							  sceneParams.teapotSpecular, sceneParams.teapotShininess,
							  sceneParams.teapotSize, function(teapot) {
							  	teapot.position.set(130, 140, -80); //set on tabletop
    							teapot.rotateY(-Math.PI/3); 
    							scene.add(teapot); }
    							);		

    //Create marble and its camera
    var marbleSet = createShinyBall(sceneParams.marbleColor, sceneParams.marbleSpecular,
    						 sceneParams.marbleShininess, sceneParams.marbleRadius );
	marble = marbleSet[0];
	marbleCam = marbleSet[1];
    
    //add the marble					 
    marble.position.set(-40, sceneParams.tableHeight, -170 );
	scene.add(marble);	
	
	//add the camera that makes the marble reflective
	marbleCam.position.set(10, (sceneParams.marbleRadius), 0 );
	scene.add(marbleCam);
	
	//Create and place the chandelier
	chand = createChandelier(42, 4, true, "glass.jpg", "bronze.jpg");
	chand.position.set(0,sceneParams.roomH, 0);
	scene.add(chand);	 
  
    //Create and place blocks
    var block1 = createBlock(sceneParams.blockColor, sceneParams.blockSpecular,
     						 sceneParams.blockShininess, sceneParams.blockSize,
     						 sceneParams.blockTexture );  
    block1.position.set(-30, sceneParams.tableHeight, -90);  
    block1.rotateY(Math.PI/2); 						 
    scene.add(block1);
    
    var block2 = block1.clone();
    block2.position.x += 8;
    scene.add(block2);
    
    var block3 = block2.clone();
    block3.position.x += 8;
    scene.add(block3);
    
    var block4 = block3.clone();
    block4.position.x += 8;
    scene.add(block4);
    
    var block5 = block4.clone();
    block5.position.x += 6;
    block5.position.z += 2;
    block5.rotateY(-Math.PI/6); 
    scene.add(block5);
    
    var block6 = block5.clone();
    block6.position.x += 5;
    block6.position.z += 3;
    block6.rotateY(-Math.PI/6); 
    scene.add(block6);
    
    var block7 = block6.clone();
    block7.position.x += 4;
    block7.position.z += 4;
    block7.rotateY(-Math.PI/6); 
    scene.add(block7);

    // create little slide using Slide function
    // (height, length, width, inputColor, inputShininess, isLipped)
    var slide = createSlide (sceneParams.slideHeight,
                    sceneParams.slideLength,
                    sceneParams.slideWidth,
                    sceneParams.slideColor,
                    sceneParams.slideShininess,
                    sceneParams.slideLip);
    slide.position.set(-80, sceneParams.tableHeight, -90);
    slide.rotateY(Math.PI/2);
    scene.add(slide);
    
    // create ramp using Slide function
    // (height, length, width, inputColor, inputShininess, isLipped)
    var ramp = createSlide (sceneParams.rampHeight,
                    sceneParams.rampLength,
                    sceneParams.rampWidth,
                    sceneParams.rampColor,
                    sceneParams.rampShininess,
                    sceneParams.rampLip);
    ramp.position.set(10, 0, -43.5);
    scene.add(ramp);
    
    // Add small ornaments to shelves, referencing other CS307 projects.
    // Sarah Bailin's penguin
    var toyPenguin = sbailinPenguin(false, false, 10, 0x444444); 
    toyPenguin.position.set(130, 100, -130);
    //toyPenguin.scale.set(0.8,0.8,0.8);
    scene.add(toyPenguin);
    
    // Laura Shih's (?) rocket
    var toyRocket = createRocket(sceneParams.toyRocketBodyColor,
    							sceneParams.toyRocketNoseColor, 
    							sceneParams.toyRocketFinColor, 
    							sceneParams.toyRocketThrusterColor, 
    							sceneParams.toyRocketCabinColor);
    toyRocket.scale.set(.5, .5, .5);
    toyRocket.rotateX(Math.PI/2.25);
    toyRocket.position.set(130, 150, -130);
    scene.add(toyRocket);
    
    
    // Note:  objects that don't hold up and cannot be included without significant effort:  
    // Emily's Christmas tree, Emily Q's koi, Mary Beth Kery's house,
    
    
    
    
    
    //Create and place window
	var window = createWindow(sceneParams.windowWidth, sceneParams.windowframeColor, sceneParams.windowVideo);
	window.name="window";
	window.position.set(-(w2 * 1.5), w2, -(w2/3));
	window.rotateY(Math.PI/2); //rotate to be in the wall's plane
	scene.add(window);
	
	
    TW.render();
  }

  // Light section:  add lights as appropriate

  //create ambient light
  var ambLight = new THREE.AmbientLight( sceneParams.ambLightColor); // soft white light 
  ambLight.name = "ambient";
  scene.add( ambLight );

  // create directional light
  var dirlight = new THREE.DirectionalLight( sceneParams.dirLightColor );
  dirlight.position.set(5,5,8);
  ambLight.name = "directional";
  scene.add(dirlight);

  // create directional light from window
  var dirlight2 = new THREE.DirectionalLight( sceneParams.dirLightColor );
  dirlight2.position.set(-5,2,-4);
  ambLight.name = "directional2";
  scene.add(dirlight2);

  // Finish camera and place scene on view.
  var state = TW.cameraSetup(renderer,
					   scene,
					   {minx: -(sceneParams.roomH * 1.5)/2, 
						  maxx: (sceneParams.roomH * 1.5)/2,
						miny: 0, maxy: sceneParams.roomH,
						minz: -(sceneParams.roomH * 1.5)/2,
						  maxz: (sceneParams.roomH * 1.5)/2});  
  //to allow better zooming
  state.cameraObject.near = 1;  
  state.cameraObject.updateProjectionMatrix();
	      
  drawScene();


  function updateMarblePosition(time) {
    var deltaAngle = sceneParams.marbleAngularVelocity * sceneParams.deltaT;
    animationState.marbleAngle += deltaAngle; // in radians
    // if the ball w/ radius R rotates by r radians, the ball rolls R * r units but to the *left*
    animationState.marbleX += -1 * sceneParams.marbleRadius * deltaAngle;
    animationState.marbleZ += 1 * sceneParams.marbleRadius * deltaAngle;
    
    
    marble.position.x = animationState.marbleX;
    marbleCam.position.x = marble.position.x;
    //marble.position.y = animationState.marbleY;
    //marbleCam.position.y = marble.position.y;
    marble.position.z = animationState.marbleZ;
    marbleCam.position.z = marble.position.z;
    marble.rotateX(deltaAngle);
  }

  function animate() 
  {
    requestAnimationFrame( animate );
	render();		
  }

  function updateState() {
    // changes the time and everything in the state that depends on it
    animationState.time += sceneParams.deltaT;
    if (animationState.time < 80) { 
    	//updateMarblePosition(animationState.time);
    }
  }

  function render() 
  {	
    // update marble 
    marble.visible = false;
    updateState();
    marbleCam.updateCubeMap(renderer, scene);
    marble.visible = true;

	//update video
	if (video.readyState === video.HAVE_ENOUGH_DATA) 
	{
		videoImageContext.drawImage(video, 0, 0);
		if (videoTexture) videoTexture.needsUpdate = true;
	}
	renderer.render(scene, state.cameraObject); //re-render the scene using the TW camera
  }

  animate(); //allows video to play

  </script>
  </body>
</html>

